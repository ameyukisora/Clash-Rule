name: Fetch and Convert chnroutes.txt

on: workflow_dispatch

jobs:
  fetch_and_convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Fetch chnroutes.txt
      run: curl -o chnroutes.txt https://raw.githubusercontent.com/misakaio/chnroutes2/master/chnroutes.txt

    - name: Convert and Save to Clash-Rule/provider
      run: |
        echo 'payload:' > chnroutes.yaml
        sed -n '1,2p' chnroutes.txt >> chnroutes.yaml
        sed -n '4,$p' chnroutes.txt | sed 's/.*/  - '\''&'\''/' >> chnroutes.yaml
        mkdir -p Clash-Rule/provider
        mv chnroutes.yaml Clash-Rule/provider/
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Clash-Rule/provider/chnroutes.yaml
        git commit -m "Update chnroutes.yaml"
        git push
