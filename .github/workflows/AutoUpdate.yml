name: autoupdate

on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

# 添加权限声明，确保有权限推送到仓库
permissions:
  contents: write

jobs:
  autoupdate_python:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # 锁定大版本，避免未来接口变更导致错误
      
      - name: Set up Python
        uses: actions/setup-python@v5 # 使用 v5 版本
        with:
          python-version: '3.11' # 指定具体版本比 '3.x' 更稳定，且利用缓存更有效
          # 开启 pip 缓存，加速后续构建
          cache: 'pip'
          cache-dependency-path: '.github/workflows/python/requirements.txt'
      
      - name: Install dependencies
        run: pip install -r .github/workflows/python/requirements.txt

      - name: Run all update scripts
        run: |
          python .github/workflows/python/chnroutes2.py
          python .github/workflows/python/chn-operator-ip.py
          python .github/workflows/python/gfw.py
          python .github/workflows/python/cndomain.py

      - name: Commit and push changes
        # 设置时区环境变量，让 date 命令直接输出正确时间，无需复杂计算
        env:
          TZ: Asia/Shanghai
        run: |
          # 检查 autoupdate 目录下是否有变更
          if [[ $(git status --porcelain autoupdate/*.yaml) ]]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add autoupdate/*.yaml
            git commit -m "Update rules: $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          else
            echo "No changes to commit."
          fi